$(document).ready(function(){const api='https://webclient.gamecluster.nextrp.ru';const userHttp=new UserHttp();const utils=new Utils();function shake(thing){const interval=5;const distance=2;const times=3;for(var i=0;i<(times+1);i++){$(thing).animate({left:(i%2==0?distance:distance*-1)},interval);}
$(thing).animate({left:0,top:0},interval);}
$('.inputFieldContainer input, .inputFieldWrapper-textarea textarea').focus(function(){$(this).closest('.inputFieldContainer').removeClass('invalidInput');})
function closeModal(){$('body').removeClass('isModaled');$('.modalWrap').each(function(index){$(this).removeClass('visibleModal');});history.pushState("",document.title,window.location.href.substr(0,window.location.href.indexOf('#')));}
function clearInputVal(el){if($(window).width()<768)el.val('');}
$('.modalRegBtn').click(function(){let isValidated=true;var re=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;if(!$('.modalRegEmail').val()||!re.test(String($('.modalRegEmail').val()).toLowerCase())){shake($('.modalRegEmail'));$('.inputFieldContainerModalRegEmail').addClass('invalidInput');clearInputVal($('.modalRegEmail'));$('.inputFieldContainerModalRegEmail .inputFieldResult').text('Неверный почтовый адрес');isValidated=false;}
if(!$('.modalRegLogin').val()){shake($('.modalRegLogin'));$('.inputFieldContainerModalRegLogin').addClass('invalidInput');clearInputVal($('.modalRegLogin'));$('.inputFieldContainerModalRegLogin .inputFieldResult').text('Введите логин');isValidated=false;}
if(!$('.modalRegPassword').val()){shake($('.modalRegPassword'));$('.inputFieldContainerModalRegPassword').addClass('invalidInput');clearInputVal($('.modalRegPassword'));$('.inputFieldContainerModalRegPassword .inputFieldResult').text('Введите пароль');isValidated=false;}
if(!$('.modalRegPasswordRepeat').val()||($('.modalRegPassword').val()!=$('.modalRegPasswordRepeat').val())){shake($('.modalRegPasswordRepeat'));$('.inputFieldContainerModalRegPasswordRepeat').addClass('invalidInput');clearInputVal($('.modalRegPasswordRepeat'));$('.inputFieldContainerModalRegPasswordRepeat .inputFieldResult').text('Пароли не совпадают');isValidated=false;}
if(!$('.modalRegAgree').is(':checked')){shake($('.modalRegAgree'));$('.inputFieldContainerModalRegAgree').addClass('invalidInput');isValidated=false;}
if(isValidated){const params={email:$(".modalRegEmail").val(),username:$(".modalRegLogin").val(),password:$(".modalRegPassword").val(),gaCID:Cookies.get('_ga')||null,initQuery:Cookies.get('initQuery')?JSON.parse(Cookies.get('initQuery')):null};$.ajax({type:'POST',contentType:"application/json",url:api+'/register',data:JSON.stringify(params),dataType:"json",success:function(data){userHttp.login({token:data.data.token});closeModal();},error:function(err){if(err.responseJSON.message=='E-mail уже используется'){shake($('.modalRegEmail'));$('.inputFieldContainerModalRegEmail').addClass('invalidInput');clearInputVal($('.modalRegEmail'));$('.inputFieldContainerModalRegEmail .inputFieldResult').text(err.responseJSON.message);}
if(err.responseJSON.message=='Имя уже используется'){shake($('.modalRegLogin'));$('.inputFieldContainerModalRegLogin').addClass('invalidInput');clearInputVal($('.modalRegLogin'));$('.inputFieldContainerModalRegLogin .inputFieldResult').text(err.responseJSON.message);}
if(err.responseJSON.message=='The password can not be less than 4.'){shake($('.modalRegPassword'));$('.inputFieldContainerModalRegPassword').addClass('invalidInput');clearInputVal($('.modalRegPassword'));$('.inputFieldContainerModalRegPassword .inputFieldResult').text('Пароль меньше 4 символов');shake($('.modalRegPasswordRepeat'));$('.inputFieldContainerModalRegPasswordRepeat').addClass('invalidInput');clearInputVal($('.modalRegPasswordRepeat'));$('.inputFieldContainerModalRegPasswordRepeat .inputFieldResult').text('Пароль меньше 4 символов');}}});}})
$('.modalLogBtn').click(function(){let isValidated=true;if(!$('.modalLogLogin').val()){shake($('.modalLogLogin'));$('.inputFieldContainerModalLogLogin').addClass('invalidInput');clearInputVal($('.modalLogLogin'));$('.inputFieldContainerModalLogLogin .inputFieldResult').text('Заполните поле');isValidated=false;}
if(!$('.modalLogPassword').val()){shake($('.modalLogPassword'));$('.inputFieldContainerModalLogPassword').addClass('invalidInput');clearInputVal($('.modalLogPassword'));$('.inputFieldContainerModalLogPassword .inputFieldResult').text('Заполните поле');isValidated=false;}
if(isValidated){const params={ident:$(".modalLogLogin").val(),password:$(".modalLogPassword").val()};$.ajax({type:'POST',url:api+'/login',data:params,success:function(data){console.log(data.data);userHttp.login({token:data.data.token});},error:function(err){if(err.responseJSON.message=='Неверный пароль'){shake($('.modalLogPassword'));$('.inputFieldContainerModalLogPassword').addClass('invalidInput');clearInputVal($('.modalLogPassword'));$('.inputFieldContainerModalLogPassword .inputFieldResult').text(err.responseJSON.message);}
if(err.responseJSON.message=='Неверный логин или пароль'){shake($('.modalLogLogin'));$('.inputFieldContainerModalLogLogin').addClass('invalidInput');clearInputVal($('.modalLogLogin'));$('.inputFieldContainerModalLogLogin .inputFieldResult').text("Неверные данные");shake($('.modalLogPassword'));$('.inputFieldContainerModalLogPassword').addClass('invalidInput');clearInputVal($('.modalLogPassword'));$('.inputFieldContainerModalLogPassword .inputFieldResult').text("Неверные данные");}
if(err.responseJSON.message=='user not found'){shake($('.modalLogLogin'));$('.inputFieldContainerModalLogLogin').addClass('invalidInput');clearInputVal($('.modalLogLogin'));$('.inputFieldContainerModalLogLogin .inputFieldResult').text("Пользователь не найден");}}});}})
$('.modalAuthBtn').click(function(){let isValidated=true;if(!$('.modalAuthLog').val()){shake($('.modalAuthLog'));$('.inputFieldContainerModalAuthLog').addClass('invalidInput');clearInputVal($('.modalAuthLog'));$('.inputFieldContainerModalAuthLog .inputFieldResult').text('Введите логин');isValidated=false;}
if(!$('.modalAuthPassword').val()){shake($('.modalAuthPassword'));$('.inputFieldContainerModalAuthPassword').addClass('invalidInput');clearInputVal($('.modalAuthPassword'));$('.inputFieldContainerModalAuthPassword .inputFieldResult').text('Введите пароль');isValidated=false;}
if(isValidated){const params={ident:$(".modalAuthLog").val(),password:$(".modalAuthPassword").val()};$.ajax({type:'POST',url:api+'/login',data:params,success:function(data){console.log(data);userHttp.login({token:data.data.token});closeModal();},error:function(err){if(err.responseJSON.message=='Неверный пароль'){shake($('.modalAuthPassword'));$('.inputFieldContainerModalAuthPassword').addClass('invalidInput');clearInputVal($('.modalAuthPassword'));$('.inputFieldContainerModalAuthPassword .inputFieldResult').text(err.responseJSON.message);}
if(err.responseJSON.message=='Неверный логин или пароль'){shake($('.modalAuthLog'));$('.inputFieldContainerModalAuthLog').addClass('invalidInput');clearInputVal($('.modalAuthLog'));$('.inputFieldContainerModalAuthLog .inputFieldResult').text('Неверные данные');shake($('.modalAuthPassword'));$('.inputFieldContainerModalAuthPassword').addClass('invalidInput');clearInputVal($('.modalAuthPassword'));$('.inputFieldContainerModalAuthPassword .inputFieldResult').text('Неверные данные');}
if(err.responseJSON.message=='user not found'){shake($('.modalAuthLog'));$('.inputFieldContainerModalAuthLog').addClass('invalidInput');clearInputVal($('.modalAuthLog'));$('.inputFieldContainerModalAuthLog .inputFieldResult').text("Пользователь не найден");}}});}})
let isSendingSupport=false;$('.modalSupportBtn').click(function(){let isValidated=true;var re=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;if(!$('.modalSupportEmail').val()||!re.test(String($('.modalSupportEmail').val()).toLowerCase())){shake($('.modalSupportEmail'));$('.inputFieldContainerModalSupportEmail').addClass('invalidInput');clearInputVal($('.modalSupportEmail'));$('.inputFieldContainerModalSupportEmail .inputFieldResult').text('Неверный почтовый адрес');isValidated=false;}
const filesInput=$('.uploaderImages')[0]
const payload={email:$(".modalSupportEmail").val(),vklink:$(".modalSupportVk").val(),message:$("textarea.modalSupportMessage").val(),files:filesInput.files||filesInput.dataTransfer.files,}
const formData=new FormData()
formData.append('email',payload.email)
formData.append('vklink',payload.vklink)
formData.append('message',payload.message)
for(let file of payload.files){formData.append('images[]',file,file.name)}
if(isValidated&&!isSendingSupport){isSendingSupport=true;$(".modalSupportEmail").val('');$(".modalSupportVk").val('');$("textarea.modalSupportMessage").val('');$('.uploaderImages').val('')
$('.uploadImages').empty();fetch('/send.php',{method:'POST',body:formData}).then(res=>{closeModal();utils.showNotification('Ваше сообщение отправлено','Мы свяжемся с вами в ближайшее время');isSendingSupport=false;})}})
$('.modalRestorePasswordBtn').click(function(){let isValidated=true;var re=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;if(!$('.modalRestorePasswordEmail').val()||!re.test(String($('.modalRestorePasswordEmail').val()).toLowerCase())){shake($('.modalRestorePasswordEmail'));$('.inputFieldContainerModalRestorePasswordEmail').addClass('invalidInput');clearInputVal($('.modalRestorePasswordEmail'));$('.inputFieldContainerModalRestorePasswordEmail .inputFieldResult').text('Неверный почтовый адрес');isValidated=false;}
if(isValidated){const params={email:$('.modalRestorePasswordEmail').val()};$.ajax({type:'POST',url:api+'/recovery-password',data:params,success:function(data){console.log(data);utils.showNotification('Письмо с кодом восстановления отправлено на указанный адрес почты!','');closeModal();},error:function(err){if(err.responseJSON.message=='User not found'){shake($('.modalRestorePasswordEmail'));$('.inputFieldContainerModalRestorePasswordEmail').addClass('invalidInput');clearInputVal($('.inputFieldContainerModalRestorePasswordEmail'));$('.inputFieldContainerModalRestorePasswordEmail .inputFieldResult').text('Пользователь не найден');}
console.log(err.responseJSON.message);}});}})
$('.modalRestorePasswordNewBtn').click(function(){let isValidated=true;if(!$('.modalRestorePasswordNewPassword').val()){shake($('.modalRestorePasswordNewPassword'));$('.inputFieldContainerModalRestorePasswordNewPassword').addClass('invalidInput');clearInputVal($('.modalRestorePasswordNewPassword'));$('.inputFieldContainerModalRestorePasswordNewPassword .inputFieldResult').text('Введите пароль');isValidated=false;}
if(!$('.modalRestorePasswordNewPasswordRepeat').val()||($('.modalRestorePasswordNewPasswordRepeat').val()!=$('.modalRestorePasswordNewPassword').val())){shake($('.modalRestorePasswordNewPasswordRepeat'));$('.inputFieldContainerModalRestorePasswordNewPasswordRepeat').addClass('invalidInput');clearInputVal($('.modalRestorePasswordNewPasswordRepeat'));$('.inputFieldContainerModalRestorePasswordNewPasswordRepeat .inputFieldResult').text('Пароли не совпадают');isValidated=false;}
const urlParams=new URLSearchParams(window.location.search);const recoveryCode=urlParams.get('recoveryCode')||'';if(isValidated&&recoveryCode){const params={newPassword:$('.modalRestorePasswordNewPassword').val()};console.log(params,recoveryCode)
$.ajax({type:'POST',url:api+'/recovery-password/'+recoveryCode,data:params,success:function(data){userHttp.login({token:data.data.token});$('body').removeClass('isModaled');$('.modalWrap').each(function(index){$(this).removeClass('visibleModal');});history.pushState("",document.title,window.location.href.substr(0,window.location.href.indexOf('?')));},error:function(err){if(err.responseJSON.message=='Validation error'){if(err.responseJSON.data.newPassword.rule=='minLength'){shake($('.modalRestorePasswordNewPassword'));$('.inputFieldContainerModalRestorePasswordNewPassword').addClass('invalidInput');clearInputVal($('.modalRestorePasswordNewPassword'));$('.inputFieldContainerModalRestorePasswordNewPassword .inputFieldResult').text('Пароль меньше 4 символов');shake($('.modalRestorePasswordNewPasswordRepeat'));$('.inputFieldContainerModalRestorePasswordNewPasswordRepeat').addClass('invalidInput');clearInputVal($('.modalRestorePasswordNewPasswordRepeat'));$('.inputFieldContainerModalRestorePasswordNewPasswordRepeat .inputFieldResult').text('Пароль меньше 4 символов');}}
console.log(err.responseJSON.message);}});}})
$('.modalPremium .modalHeader-subtitle').click(function(){if(!$('.modalPremium').hasClass('premiumIsDesced')&&!$('.modalPremium').hasClass('premiumIsChoiced'))$('.modalPremium').addClass('premiumIsDesced');})
$('.modalPremium .premiumDescriptions_headerBack').click(function(){if($('.modalPremium').hasClass('premiumIsDesced'))$('.modalPremium').removeClass('premiumIsDesced');})
$('.premiumBuyBlock-return').click(function(){$('.modalPremium').removeClass('premiumIsChoiced');})
let premiumOptionActive='';$('.premiumBuyBtn').click(function(){if($(window).width()>1280)
{let isValidated=true;const days=$(this).attr('data-premiumdays');if(!$('.serverPremiumSelect').val()){shake($('.serverPremiumSelect'));$('.serverPremiumSelectContainer').addClass('invalidInput');$('.serverPremiumSelectContainer .inputFieldResult').text('Необходимо выбрать сервер');isValidated=false;}
if(isValidated){const params={game_server:parseInt($('.serverPremiumSelect').val()),pack_id:parseInt(days),client_id:userHttp.getUser().clientId,source:"web"};var xmlhttp=new XMLHttpRequest();xmlhttp.open("POST","https://pyapi.gamecluster.nextrp.ru/v1.0/payments/pay/unitpay");xmlhttp.setRequestHeader("Content-Type","application/json;charset=UTF-8");xmlhttp.send(JSON.stringify(params));xmlhttp.onreadystatechange=function(){if(this.readyState==4){if(this.status==200)
document.write(xmlhttp.responseText);else
console.log('ajax error');}};}}
else{if(!$('.modalPremium').hasClass('premiumIsDesced')&&!$('.modalPremium').hasClass('premiumIsChoiced'))$('.modalPremium').addClass('premiumIsChoiced');premiumOptionActive=$(this).attr('data-premiumdays');$('.premiumBuy-name > span').text($(this).attr('data-premium_name'));}})
$('.premiumBuyContainerBtn').click(function(){let isValidated=true;if(!$('.serverPremiumBuySelect').val()){shake($('.serverPremiumBuySelect'));$('.serverPremiumBuySelectContainer').addClass('invalidInput');$('.serverPremiumBuySelectContainer .inputFieldResult').text('Необходимо выбрать сервер');isValidated=false;}
if(isValidated){const params={game_server:parseInt($('.serverPremiumBuySelect').val()),pack_id:parseInt(premiumOptionActive),client_id:userHttp.getUser().clientId,source:"web"};var xmlhttp=new XMLHttpRequest();xmlhttp.open("POST","https://pyapi.gamecluster.nextrp.ru/v1.0/payments/pay/unitpay");xmlhttp.setRequestHeader("Content-Type","application/json;charset=UTF-8");xmlhttp.send(JSON.stringify(params));xmlhttp.onreadystatechange=function(){if(this.readyState==4){if(this.status==200)
document.write(xmlhttp.responseText);else
console.log('ajax error');}};}})
$('.paymentOptions li').click(function(){$('.modalPaymentSum').val($(this).find('.paymentOption_sum').text());$('.modalPaymentSum').closest('.inputFieldContainer').removeClass('invalidInput');});$('.modalPaymentBtn').click(function(){let isValidated=true;if(!$('.serverPaymentSelect').val()){shake($('.serverPaymentSelect'));$('.serverPaymentSelectContainer').addClass('invalidInput');$('.serverPaymentSelectContainer .inputFieldResult').text('Необходимо выбрать сервер');isValidated=false;}
if(!$('.modalPaymentSum').val()){shake($('.modalPaymentSum'));$('.inputFieldContainerModalPaymentSum').addClass('invalidInput');clearInputVal($('.modalPaymentSum'));$('.inputFieldContainerModalPaymentSum .inputFieldResult').text('Введите сумму');isValidated=false;}
if($('.modalPaymentSum').val()&&parseInt($('.modalPaymentSum').val())<50){shake($('.modalPaymentSum'));$('.inputFieldContainerModalPaymentSum').addClass('invalidInput');clearInputVal($('.modalPaymentSum'));$('.inputFieldContainerModalPaymentSum .inputFieldResult').text('Мин. платеж - 50р');isValidated=false;}
if(!$('.modalPaymentAgree').is(':checked')){shake($('.modalPaymentAgree'));$('.inputFieldContainerModalPaymentAgree').addClass('invalidInput');isValidated=false;}
if(isValidated){const params={game_server:parseInt($('.serverPaymentSelect').val()),sum:parseInt($('.modalPaymentSum').val()),client_id:userHttp.getUser().clientId,source:"web"};var xmlhttp=new XMLHttpRequest();xmlhttp.open("POST","https://pyapi.gamecluster.nextrp.ru/v1.0/payments/pay/unitpay");xmlhttp.setRequestHeader("Content-Type","application/json;charset=UTF-8");xmlhttp.send(JSON.stringify(params));xmlhttp.onreadystatechange=function(){if(this.readyState==4){if(this.status==200)
document.write(xmlhttp.responseText);else
console.log('ajax error');}};}})
$('.modalPaymentLogBtn').click(function(){let isValidated=true;if(!$('.modalPaymentLogLogin').val()){shake($('.modalPaymentLogLogin'));$('.inputFieldContainerModalPaymentLogLogin').addClass('invalidInput');clearInputVal($('.modalPaymentLogLogin'));$('.inputFieldContainerModalPaymentLogLogin .inputFieldResult').text('Введите логин');isValidated=false;}
if(!$('.modalPaymentLogPassword').val()){shake($('.modalPaymentLogPassword'));$('.inputFieldContainerModalPaymentLogPassword').addClass('invalidInput');clearInputVal($('.modalPaymentLogPassword'));$('.inputFieldContainerModalPaymentLogPassword .inputFieldResult').text('Введите пароль');isValidated=false;}
if(isValidated){const params={ident:$(".modalPaymentLogLogin").val(),password:$(".modalPaymentLogPassword").val()};$.ajax({type:'POST',url:api+'/login',data:params,success:function(data){userHttp.login({token:data.data.token});},error:function(err){if(err.responseJSON.message=='Неверный пароль'){shake($('.modalPaymentLogPassword'));$('.inputFieldContainerModalPaymentLogPassword').addClass('invalidInput');clearInputVal($('.modalPaymentLogPassword'));$('.inputFieldContainerModalPaymentLogPassword .inputFieldResult').text('Неверные данные');}
if(err.responseJSON.message=='Неверный логин или пароль'){shake($('.modalPaymentLogLogin'));$('.inputFieldContainerModalPaymentLogLogin').addClass('invalidInput');clearInputVal($('.modalPaymentLogLogin'));$('.inputFieldContainerModalPaymentLogLogin .inputFieldResult').text('Неверные данные');shake($('.modalPaymentLogPassword'));$('.inputFieldContainerModalPaymentLogPassword').addClass('invalidInput');clearInputVal($('.modalPaymentLogPassword'));$('.inputFieldContainerModalPaymentLogPassword .inputFieldResult').text('Неверные данные');}
if(err.responseJSON.message=='user not found'){shake($('.modalPaymentLogLogin'));$('.inputFieldContainerModalPaymentLogLogin').addClass('invalidInput');clearInputVal($('.modalPaymentLogLogin'));$('.inputFieldContainerModalPaymentLogLogin .inputFieldResult').text('Неверные данные');}}});}})
$('.logout').click(function(e){e.stopPropagation();userHttp.logout();$('.accountPopupContainer').removeClass('accountPopupContainerIsVisible');$('body').addClass('isUnregUser');});const urlParamsCB=new URLSearchParams(window.location.search);if((Cookies.get('initQuery')||Cookies.get('_ga'))&&urlParamsCB.has('clientId')){const params={clientId:urlParamsCB.get('clientId'),gaCID:Cookies.get('_ga')||null,initQuery:Cookies.get('initQuery')?JSON.parse(Cookies.get('initQuery')):null}
$.ajax({type:'POST',contentType:"application/json",url:api+'/thanks',data:JSON.stringify(params),dataType:"json",success:function(data){$('body').addClass('isModaled');$('.modalWrap').each(function(index){$(this).removeClass('visibleModal');});$('.modalThanks').addClass('visibleModal');window.history.pushState("",document.title,window.location.href.substr(0,window.location.href.indexOf('?')));}});}});